#!/bin/bash

set -u

readonly DOTFILES_ROOT=~/dotfiles
readonly DOTFILES_SETUP_DIR=$DOTFILES_ROOT/dotfiles
readonly MANDATORY_MODULES="bash git scripts"
readonly EXTRA_MODULES_FILE=$DOTFILES_SETUP_DIR/extra_modules

readonly IGNORE_FOR_SYMLINKS="Library/Containers Library/Caches/com.apple.bird"

pushd $DOTFILES_ROOT
git pull origin-ro master
for module in $MANDATORY_MODULES; do
    echo "Re-creating symlinks for $module"
    stow $module
done
# Extra modules, if defined
for module in $(cat $EXTRA_MODULES_FILE); do
    echo "Re-creating symlinks for optional $module"
    stow $module
done
# Since we cannot do stow -D before git pull, check manually for any now-stray symlinks
echo "Stray symlinks in $HOME, if any:"
find_ignore_paths=""
for find_ignore_path in $IGNORE_FOR_SYMLINKS; do
    find_ignore_paths+="-path $HOME/$find_ignore_path -prune -o "
done
find ~ $find_ignore_paths -type l ! -exec test -e {} \; -print 2>/dev/null
echo "End of stray symlink list"
popd
