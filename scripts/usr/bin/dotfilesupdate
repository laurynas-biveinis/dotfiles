#!/bin/bash

set -u

readonly DOTFILES_ROOT=~/dotfiles
readonly DOTFILES_SETUP_DIR=$DOTFILES_ROOT/dotfiles
readonly MANDATORY_MODULES="bash git scripts"
readonly EXTRA_MODULES_FILE=$DOTFILES_SETUP_DIR/extra_modules

readonly IGNORE_FOR_SYMLINKS=("Library/Containers" \
                              "Library/Caches/com.apple.bird" \
                              "Library/Saved Application State")

pushd $DOTFILES_ROOT || exit
git pull origin-ro master
echo -n "Re-creating symlinks for:"
for module in $MANDATORY_MODULES; do
    echo -n " $module"
    stow "$module"
done
# Extra modules, if defined
IFS=" " read -r -a extra_modules < $EXTRA_MODULES_FILE
for extra_module in "${extra_modules[@]}"; do
    echo -n " [$extra_module]"
    stow "$extra_module"
done
echo
# Since we cannot do stow -D before git pull, check manually for any now-stray symlinks
echo "Stray symlinks in $HOME, if any:"
find_ignore_paths=()
for find_ignore_path in "${IGNORE_FOR_SYMLINKS[@]}"; do
    find_ignore_paths+=("-path" "$HOME/$find_ignore_path" "-prune" "-o")
done
# A useful alternative would be "(cd $DOTFILE_ROOT && chkstow -b)", but this
# command finds non-stow-managed stray symlinks too
find ~ "${find_ignore_paths[@]}" -type l ! -exec test -e {} \; -print 2>/dev/null
echo "End of stray symlink list"
popd || exit
