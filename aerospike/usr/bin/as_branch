#!/bin/bash

# Create or checkout a new pair of CE/EE Aerospike feature branches, set up
# project

set -u

readonly COMMAND=$1

if [[ $COMMAND != "create" && $COMMAND != "checkout" && $COMMAND != "fetch" ]];
then
    echo "Usage: $0 create branch [starting_point]"
    echo "Usage: $0 checkout branch"
    echo "       $0 fetch"
    exit 1
fi

readonly CE_MASTER="$ASD_MASTER/ce"
readonly EE_MASTER="$ASD_MASTER/ee"

pushd "$ASD_BRANCHES" || exit 1

if [[ $COMMAND == "fetch" ]]; then
    pushd "$EE_MASTER" || exit 1
    git fetch --all -p --recurse-submodules=yes -j 5
    popd || exit 1

    pushd "$CE_MASTER" || exit 1
    git fetch --all -p --recurse-submodules=yes -j 5
    popd || exit 1

    popd || exit 0
    exit 0
fi

readonly BRANCH=$2

if [[ $COMMAND == "create" && "$#" -gt 2 ]]; then
    readonly START_POINT=$3
else
    readonly START_POINT=
fi

readonly BRANCH_ROOT=$ASD_BRANCHES/$BRANCH

readonly SUPPORT_FILE_DIR="$HOME/dotfiles/aerospike/aerospike"

mkdir "$BRANCH"

pushd "$EE_MASTER" || exit 1
if [[ $COMMAND == "create" ]]; then
    git worktree add "$BRANCH_ROOT/ee" -b "$BRANCH" "$START_POINT"
else
    git worktree add "$BRANCH_ROOT/ee" "$BRANCH"
fi
popd || exit 1

pushd "$CE_MASTER" || exit 1
if [[ $COMMAND == "create" ]]; then
    git worktree add "$BRANCH_ROOT/ce" -b "$BRANCH" "$START_POINT"
else
    git worktree add "$BRANCH_ROOT/ce" "$BRANCH"
fi
popd || exit 1

pushd "$BRANCH/ee" || exit 1
git submodule update --init
ln -sf "../ce/compile_commands.json" .
popd || exit 1

pushd "$BRANCH/ce" || exit 1
git submodule update --init
popd || exit 1

pushd "$BRANCH" || exit 1
ln -sf "$SUPPORT_FILE_DIR/.clang-format" .
cp "$SUPPORT_FILE_DIR/asd-.dir-locals.el" .dir-locals.el
ln -sf "$SUPPORT_FILE_DIR/asd-Makefile" Makefile
touch .projectile
make build
popd || exit 0

popd || exit 0
